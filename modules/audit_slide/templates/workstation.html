{% extends 'layout.html' %}

{% block title %}ID Workstation{% endblock %}

{% block content %}
<style>
    /* --- WORKSTATION SPECIFIC STYLES (Merged from report_spa.html) --- */
    .workstation-container { display: flex; height: calc(100vh - 80px); gap: 0; } /* Remove gap for seamless sidebar */
    
    /* LEFT PANEL: SLIDE NAVIGATOR */
    .slide-nav-panel { width: 300px; background: #fff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; }
    .nav-header { padding: 20px; border-bottom: 1px solid #f1f5f9; background: #f8fafc; }
    .nav-title { font-size: 0.9rem; font-weight: 700; color: var(--primary-navy); text-transform: uppercase; letter-spacing: 0.5px; }
    .slide-list { flex: 1; overflow-y: auto; }
    .slide-item { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .slide-item:hover { background: #f8fafc; }
    .slide-item.active { background: #e0f2fe; border-left: 4px solid var(--intelligent-teal); }
    .slide-label { font-weight: 600; color: var(--slate-700); font-size: 0.9rem; }
    
    /* BADGES */
    .count-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; min-width: 24px; text-align: center; }
    .badge-fail { background: #fee2e2; color: #b91c1c; }
    .badge-clean { background: #dcfce7; color: #166534; }
    .badge-exempt { background: #f1f5f9; color: #64748b; }

    /* CENTER PANEL: MAIN STAGE */
    .main-stage { flex: 1; display: flex; flex-direction: column; background: #f8fafc; overflow: hidden; }
    .stage-header { padding: 20px 30px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .stage-title { font-size: 1.25rem; font-weight: 800; color: var(--primary-navy); }
    
    /* FILTER BAR */
    .filter-bar { display: flex; gap: 10px; }
    .filter-chip { padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid #e2e8f0; background: #fff; color: #64748b; transition: all 0.2s; }
    .filter-chip.active { background: var(--intelligent-teal); color: #fff; border-color: var(--intelligent-teal); }

    /* CONTENT AREA */
    .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
    
    /* ISSUE CARDS */
    .slide-card { background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 30px; overflow: hidden; }
    .slide-card-header { padding: 20px 30px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .btn-ai { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .btn-ai:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-ai:disabled { background: #cbd5e1; cursor: not-allowed; }

    /* ISSUE TABLE */
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px 30px; background: #f8fafc; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid #e2e8f0; }
    td { padding: 20px 30px; border-bottom: 1px solid #f1f5f9; vertical-align: top; color: #334155; font-size: 0.95rem; }
    .issue-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
    .issue-fail { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .issue-warn { background: #fefce8; color: #a16207; border: 1px solid #fef9c3; }
    
    /* FIX BUTTONS */
    .btn-fix { background: #fff; border: 1px solid var(--compliance-green); color: var(--compliance-green); padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-fix:hover { background: var(--compliance-green); color: white; }
    .btn-fix.staged { background: var(--compliance-green); color: white; cursor: default; opacity: 0.7; }

    /* AI REMEDIATION BOX */
    .remediation-box { background: #f0f9ff; border: 1px solid #bae6fd; border-left: 4px solid var(--intelligent-teal); padding: 20px; margin: 20px 30px; border-radius: 4px; }
    .critique-text { color: #475569; font-style: italic; margin-bottom: 15px; font-size: 0.95rem; line-height: 1.6; }
    .fix-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .fix-option { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 6px; }
    .fix-title { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 10px; }
</style>

<div class="workstation-container">
    <div class="slide-nav-panel">
        <div class="nav-header">
            <div class="nav-title">Slides (<span id="total-slides">0</span>)</div>
        </div>
        <div class="slide-list" id="slide-nav-list">
            </div>
    </div>

    <div class="main-stage">
        <div class="stage-header">
            <div>
                <div class="stage-title" id="stage-title">Select a Slide</div>
                <div class="filter-bar" style="margin-top:10px;">
                    <div class="filter-chip active" onclick="applyFilter('all', this)">All Issues</div>
                    <div class="filter-chip" onclick="applyFilter('wcag', this)">Compliance</div>
                    <div class="filter-chip" onclick="applyFilter('style', this)">Style</div>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" onclick="downloadDeck()" id="btn-download" disabled style="opacity:0.5;">
                    <i class="fas fa-download"></i> Apply Fixes & Download
                </button>
            </div>
        </div>

        <div class="content-scroll" id="content-area">
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const auditData = {{ audit_data | tojson }};
    const stagedFixes = {};
    const aiResultsCache = {};

    document.addEventListener('DOMContentLoaded', () => {
        if (!auditData) return;
        
        // 1. Initialize Slide List
        const totalSlides = auditData.summary.total_slides_checked;
        document.getElementById('total-slides').innerText = totalSlides;
        renderSidebar(auditData);
        
        // 2. Show First Slide
        showSlide(1);
    });

    function renderSidebar(data) {
        const list = document.getElementById('slide-nav-list');
        let html = '';
        
        // Group issues by slide
        const grouped = {};
        for(let i=1; i<=data.summary.total_slides_checked; i++) grouped[i] = [];
        data.detailed_issues.forEach(issue => {
            if (!grouped[issue.slide]) grouped[issue.slide] = [];
            grouped[issue.slide].push(issue);
        });

        Object.keys(grouped).forEach(slideNum => {
            const issues = grouped[slideNum];
            const isExempt = issues.some(i => i.result === "EXEMPT");
            const count = issues.filter(i => i.result !== "EXEMPT").length;
            
            let badgeClass = count > 0 ? 'badge-fail' : 'badge-clean';
            let badgeText = count > 0 ? count : 'âœ“';
            if (isExempt) { badgeClass = 'badge-exempt'; badgeText = 'E'; }

            html += `
            <div class="slide-item" onclick="showSlide(${slideNum})" id="nav-item-${slideNum}">
                <span class="slide-label">Slide ${slideNum}</span>
                <span class="count-badge ${badgeClass}">${badgeText}</span>
            </div>`;
        });
        list.innerHTML = html;
    }

    function showSlide(slideNum) {
        // Highlight Sidebar
        document.querySelectorAll('.slide-item').forEach(el => el.classList.remove('active'));
        const navItem = document.getElementById(`nav-item-${slideNum}`);
        if (navItem) navItem.classList.add('active');

        // Update Title
        document.getElementById('stage-title').innerText = `Slide ${slideNum} Findings`;

        // Render Content
        const contentArea = document.getElementById('content-area');
        const issues = auditData.detailed_issues.filter(i => i.slide == slideNum);
        const isExempt = issues.some(i => i.result === "EXEMPT");

        let html = `<div class="slide-card">`;
        
        // Header
        html += `
        <div class="slide-card-header">
            <div style="font-weight:700; color:#334155;">Forensic Analysis</div>
            <button class="btn-ai" onclick="analyzeSlide(${slideNum}, this)" id="btn-ai-${slideNum}">
                <i class="fas fa-robot"></i> Consult AI Agent
            </button>
        </div>`;

        // AI Result Container
        html += `<div id="ai-result-${slideNum}"></div>`;

        // Issues Table
        if (isExempt) {
            html += `<div style="padding:40px; text-align:center; color:#94a3b8;">This slide is exempt from analysis.</div>`;
        } else if (issues.length === 0) {
            html += `<div style="padding:40px; text-align:center; color:#166534;"><i class="fas fa-check-circle" style="font-size:2rem; margin-bottom:10px;"></i><br>No Issues Found</div>`;
        } else {
            html += `<table><thead><tr><th>Issue Type</th><th>Details</th><th>Recommended Action</th></tr></thead><tbody>`;
            
            issues.forEach((issue, idx) => {
                let badgeClass = issue.result === 'FAIL' ? 'issue-fail' : 'issue-warn';
                let catClass = 'category-content';
                if (issue.check.includes('WCAG')) catClass = 'category-wcag';
                if (issue.check.includes('Font') || issue.check.includes('Style')) catClass = 'category-style';

                // Logic for Fix Buttons
                let fixBtn = '<span style="color:#94a3b8; font-size:0.8rem;">Manual Review</span>';
                const shapeArg = (issue.shape_name || '').replace(/'/g, "\\'");
                
                if (issue.check.includes('Font') && issue.details.includes('below minimum')) {
                    fixBtn = `<button class="btn-fix" onclick="stageSafeFix(${slideNum}, 'fix_font_size', '${shapeArg}', this)"><i class="fas fa-magic"></i> Auto Fix Fonts</button>`;
                } else if (issue.check.includes('WCAG') && issue.details.includes('Contrast')) {
                     fixBtn = `<button class="btn-fix" onclick="stageSafeFix(${slideNum}, 'fix_contrast', '${shapeArg}', this)"><i class="fas fa-palette"></i> Smart Contrast</button>`;
                }

                html += `
                <tr class="issue-row ${catClass}">
                    <td><span class="issue-badge ${badgeClass}">${issue.check}</span></td>
                    <td>${issue.details}</td>
                    <td>${fixBtn}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        }
        
        html += `</div>`;
        contentArea.innerHTML = html;
        
        // Restore AI result if cached
        if (aiResultsCache[slideNum]) {
            renderRemediationOptions(slideNum, aiResultsCache[slideNum]);
        }
    }

    // --- AI FUNCTIONALITY ---
    window.analyzeSlide = async function(slideNum, btn) {
        if (aiResultsCache[slideNum]) return; // Already loaded

        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        
        const content = auditData.slide_content[slideNum];
        if (!content) { alert("No content found."); btn.disabled = false; return; }

        try {
            const response = await fetch('/run-ai-agent', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    slide_number: slideNum, 
                    title: content.title, 
                    full_text: content.full_text, 
                    notes: content.notes 
                })
            });
            const res = await response.json();
            if(res.status === 'success') {
                aiResultsCache[slideNum] = res.data;
                renderRemediationOptions(slideNum, res.data);
                btn.innerHTML = '<i class="fas fa-check"></i> Analysis Ready';
            } else {
                alert("AI Error: " + res.message);
                btn.disabled = false; btn.innerHTML = 'Retry';
            }
        } catch(e) { console.error(e); btn.disabled = false; btn.innerHTML = 'Error'; }
    }

    window.renderRemediationOptions = function(slideNum, data) {
        const container = document.getElementById(`ai-result-${slideNum}`);
        if (!container) return;

        const optA = data.remediation?.option_a || { label: "Polish", text: "N/A" };
        const optB = data.remediation?.option_b || { label: "Simplify", text: "N/A" };

        container.innerHTML = `
        <div class="remediation-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong style="color:var(--intelligent-teal);"><i class="fas fa-brain"></i> AI Insights</strong>
                <span style="background:#fff; padding:2px 8px; border-radius:10px; font-weight:700; font-size:0.8rem;">Clarity: ${data.clarity_score}/10</span>
            </div>
            <div class="critique-text">"${data.tone_audit}"</div>
            <div class="fix-grid">
                <div class="fix-option">
                    <div class="fix-title">OPTION A: ${optA.label}</div>
                    <div style="font-size:0.9rem;">${optA.text}</div>
                    <button class="btn-fix" style="width:100%; margin-top:10px;" onclick="stageFix(${slideNum}, 'content', '${optA.text.replace(/'/g, "\\'")}', this)">Apply</button>
                </div>
                <div class="fix-option">
                    <div class="fix-title">OPTION B: ${optB.label}</div>
                    <div style="font-size:0.9rem;">${optB.text}</div>
                    <button class="btn-fix" style="width:100%; margin-top:10px;" onclick="stageFix(${slideNum}, 'content', '${optB.text.replace(/'/g, "\\'")}', this)">Apply</button>
                </div>
            </div>
        </div>`;
    }

    // --- FIX STAGING ---
    window.stageSafeFix = function(slideNum, type, shape, btn) {
        if (!stagedFixes[slideNum]) stagedFixes[slideNum] = [];
        stagedFixes[slideNum].push({ slide_number: slideNum, type: 'safe_compliance', rule: type, shape_name: shape });
        
        btn.innerHTML = '<i class="fas fa-check"></i> Staged';
        btn.classList.add('staged');
        btn.disabled = true;
        updateDownloadBtn();
    }

    window.stageFix = function(slideNum, target, text, btn) {
        if (!stagedFixes[slideNum]) stagedFixes[slideNum] = [];
        stagedFixes[slideNum].push({ slide_number: slideNum, type: 'content_rewrite', target: target, new_text: text });
        
        btn.innerHTML = '<i class="fas fa-check"></i> Staged';
        btn.disabled = true;
        updateDownloadBtn();
    }

    function updateDownloadBtn() {
        const btn = document.getElementById('btn-download');
        btn.disabled = false;
        btn.style.opacity = 1;
    }

    window.downloadDeck = async function() {
        const btn = document.getElementById('btn-download');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        let allFixes = [];
        Object.values(stagedFixes).forEach(arr => allFixes = allFixes.concat(arr));

        try {
            const response = await fetch('/apply-fix-batch', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: auditData.summary.presentation_name, fixes: allFixes })
            });
            const res = await response.json();
            if (res.status === 'success') {
                window.location.href = res.download_url;
                btn.innerHTML = '<i class="fas fa-check"></i> Done';
            } else {
                alert("Error: " + res.message);
                btn.innerHTML = '<i class="fas fa-download"></i> Try Again';
            }
        } catch(e) { alert("Network Error"); }
    }

    window.applyFilter = function(category, btn) {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.issue-row').forEach(row => {
            if (category === 'all' || row.classList.contains(`category-${category}`)) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}
