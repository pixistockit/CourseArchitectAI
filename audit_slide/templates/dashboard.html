<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditSlide Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --navy: #0A2342; --teal: #005F73; --bg: #F4F6F8; --white: #FFF; --border: #E1E4E8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: #333; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--navy); color: white; display: flex; flex-direction: column; padding: 20px; }
        .brand { font-size: 1.5rem; font-weight: 700; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.btn-new { background: var(--teal); color: white; margin-top: 20px; justify-content: center; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .nav-item.btn-new:hover { transform: translateY(-2px); }

        /* MAIN AREA */
        .main { flex: 1; overflow-y: auto; padding: 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .search-bar { padding: 10px 15px; border: 1px solid #ccc; border-radius: 6px; width: 300px; }

        /* PROJECT GROUP */
        .project-group { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; overflow: hidden; transition: all 0.2s; }
        
        /* HEADER - NOW CLICKABLE */
        .group-header { 
            padding: 15px 25px; 
            background: #fafafa; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .group-header:hover { background: #f0f0f0; }
        
        .header-left { display: flex; align-items: center; gap: 15px; font-weight: 700; color: var(--navy); }
        .header-meta { font-weight: 400; font-size: 0.9rem; color: #888; }
        
        /* CHEVRON ROTATION */
        .fa-chevron-down { transition: transform 0.3s; }
        .project-group.collapsed .fa-chevron-down { transform: rotate(-90deg); }
        .project-group.collapsed .group-content { display: none; }
        .project-group.collapsed { border-bottom: 1px solid transparent; } /* Clean look when closed */

        /* FILE LIST */
        .group-content { border-top: 1px solid var(--border); }
        .file-row { display: flex; align-items: center; padding: 15px 25px; border-bottom: 1px solid var(--border); transition: 0.1s; background: white; }
        .file-row:last-child { border-bottom: none; }
        .file-row:hover { background: #f8f9fa; }
        
        .col-icon { width: 40px; font-size: 1.2rem; color: #888; }
        .col-name { flex: 1; font-weight: 600; color: #333; }
        .col-meta { width: 150px; font-size: 0.9rem; color: #666; }
        .col-score { width: 100px; font-weight: 700; }
        .score-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .score-good { background: #e6fffa; color: #2A9D8F; }
        .score-bad { background: #fff5f5; color: #BC4749; }
        
        .col-actions { width: 180px; display: flex; gap: 8px; justify-content: flex-end; }
        .action-btn { border: 1px solid var(--border); background: white; color: #555; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .action-btn:hover { border-color: var(--navy); color: var(--navy); }
        
        /* DELETE BUTTON STYLES */
        .btn-del:hover { border-color: #BC4749; color: #BC4749; background: #fff5f5; }
        .btn-folder-del { 
            background: transparent; border: 1px solid transparent; color: #ccc; 
            padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-folder-del:hover { color: #BC4749; background: rgba(188, 71, 73, 0.1); }

    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-layer-group"></i> AuditSlide</div>
    <a href="/" class="nav-item active"><i class="fas fa-th-large"></i> Dashboard</a>
    <a href="/" class="nav-item"><i class="fas fa-folder"></i> All Projects</a>
    <a href="/settings" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
    
    <a href="/new-audit" class="nav-item btn-new"><i class="fas fa-plus"></i> New Audit</a>
</div>

<div class="main">
    <div class="header">
        <div>
            <h1 style="margin:0; font-size:1.8rem;">Project Dashboard</h1>
            <p style="color:#666; margin-top:5px;">Manage your course audits and reports</p>
        </div>
        <input type="text" class="search-bar" placeholder="Search projects..." onkeyup="filterProjects(this.value)">
    </div>

    {% if not projects %}
        <div style="text-align:center; padding:100px; color:#888;">
            <i class="fas fa-folder-open" style="font-size:3rem; margin-bottom:20px;"></i>
            <h3>No projects found.</h3>
            <p>Click "New Audit" to analyze your first presentation.</p>
        </div>
    {% endif %}

    {% for project_name, files in projects.items() %}
    <div class="project-group" id="group-{{ loop.index }}">
        <div class="group-header" onclick="toggleGroup(this)">
            <div class="header-left">
                <i class="fas fa-chevron-down"></i>
                <i class="fas fa-folder" style="color:#E9B44C;"></i> 
                {{ project_name }}
                <span class="header-meta">({{ files|length }} files)</span>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-folder-del" style="color:var(--teal);" title="Add New Audit to this Folder" onclick="addAuditToFolder(event, '{{ project_name }}')">
                    <i class="fas fa-plus-circle"></i> Add File
                </button>

                <button class="btn-folder-del" title="Delete Entire Project Folder" onclick="deleteProjectGroup(event, '{{ project_name }}')">
                    <i class="fas fa-trash-alt"></i> Delete Folder
                </button>
            </div>
        </div>

        <div class="group-content">
            {% for file in files %}
            <div class="file-row">
                <div class="col-icon"><i class="far fa-file-powerpoint" style="color:#C43E1C;"></i></div>
                <div class="col-name">{{ file.filename }}</div>
                <div class="col-meta">{{ file.date }}</div>
                <div class="col-score">
                    <span class="score-badge {{ 'score-good' if file.score >= 80 else 'score-bad' }}">
                        {{ file.score }}%
                    </span>
                </div>
                <div class="col-actions">
                    <button class="action-btn" title="View Executive Summary" onclick="window.open('/view-report/{{ file.id }}')"><i class="fas fa-chart-bar"></i></button>
                    <button class="action-btn" title="Open ID Workstation" onclick="window.open('/view-workstation/{{ file.id }}')"><i class="fas fa-desktop"></i></button>
                    <button class="action-btn" title="Print to PDF" onclick="printReport('{{ file.id }}')"><i class="fas fa-file-pdf"></i></button>
                    <button class="action-btn btn-del" title="Delete File" onclick="deleteFile('{{ file.id }}')"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    // --- COLLAPSE LOGIC ---
    function toggleGroup(header) {
        const group = header.parentElement;
        group.classList.toggle('collapsed');
    }

    // --- DELETE FILE LOGIC ---
    function deleteFile(sessionId) {
        if(confirm("⚠️ Are you sure you want to delete this specific file?\nThis action cannot be undone.")) {
            fetch(`/delete/${sessionId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'deleted') location.reload();
            });
        }
    }

    // --- DELETE FOLDER LOGIC ---
    function deleteProjectGroup(event, projectName) {
        event.stopPropagation();
        
        const msg = `⚠️ DANGER ZONE ⚠️\n\nYou are about to delete the entire folder: "${projectName}"\n\nThis will permanently delete ALL files inside it.\nAre you absolutely sure?`;
        
        if(confirm(msg)) {
            fetch('/delete-project-group', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ project_name: projectName })
            })
            .then(res => res.json())
            .then(data => {
                location.reload();
            });
        }
    }

    function printReport(sessionId) {
        const url = `/view-report/${sessionId}?print=true`;
        window.open(url, '_blank');
    }

    function filterProjects(text) {
        const val = text.toLowerCase();
        document.querySelectorAll('.file-row').forEach(row => {
            const name = row.querySelector('.col-name').innerText.toLowerCase();
            const group = row.closest('.project-group');
            if(name.includes(val)) {
                row.style.display = 'flex';
                group.classList.remove('collapsed'); 
            } else {
                row.style.display = 'none';
            }
        });
    }

    function addAuditToFolder(event, projectName) {
        event.stopPropagation(); 
        window.location.href = `/new-audit?project=${encodeURIComponent(projectName)}`;
    }    
</script>

</body>
</html>