<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditSlide AI Report</title>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
    
    <style>
        /* BRAND TYPOGRAPHY: Precision Stack */
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap');

        :root { 
            /* BRAND PALETTE - Corporate Clarity */
            --primary-navy: #0A2342;       
            --intelligent-teal: #005F73;   
            --action-amber: #E9B44C;       
            --compliance-green: #2A9D8F;   
            --neutral-bg: #F4F6F8;         
            --white: #FFFFFF; 
            --text-dark: #334155; 
            --text-light: #64748B; 
            
            /* GAGNE EVENT PALETTE */
            --g1-attention: #94A3B8; 
            --g2-objectives: #64748B; 
            --g3-recall: #CBD5E1; 
            --g4-content: #0A2342; 
            --g5-guidance: #1E3A8A; 
            --g6-practice: #005F73; 
            --g7-feedback: #2A9D8F; 
            --g8-assess: #E9B44C; 
            --g9-retention: #B45309; 
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: var(--neutral-bg); 
            color: var(--text-dark); 
            margin: 0; padding: 0; 
            line-height: 1.6;
            font-size: 15px; 
            -webkit-font-smoothing: antialiased;
        }
        
        /* HEADERS */
        h1, h2, h3, .section-label, .kpi-value, .slide-title, .kpi-label {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* DATA */
        .meta, .slide-badge, .badge, .fix-details, .cadence-meta, .log-data {
            font-family: 'IBM Plex Mono', monospace;
        }

        .header { 
            background: linear-gradient(135deg, var(--primary-navy) 0%, #163a66 100%); 
            color: var(--white); 
            padding: 3rem 5%; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(10, 35, 66, 0.2); 
        }
        .header h1 { margin: 0; font-size: 2.2rem; font-weight: 800; letter-spacing: -0.5px; }
        .header .meta { text-align: right; font-size: 0.85rem; opacity: 0.9; line-height: 1.4; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 50px 20px; }
        .dashboard-section { margin-bottom: 50px; }
        
        .section-label { 
            font-size: 0.9rem; text-transform: uppercase; color: var(--text-light); 
            letter-spacing: 1px; font-weight: 700; margin-bottom: 20px; 
            border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; display: inline-block; 
        }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px; }
        
        .kpi-card { 
            background: var(--white); padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
            transition: all 0.3s ease; position: relative; overflow: hidden; 
            border: 1px solid #e2e8f0; border-top: 5px solid transparent; 
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        .kpi-total { border-color: var(--primary-navy); } 
        .kpi-warn { border-color: var(--action-amber); background: #FFFCF5; }
        .kpi-pass { border-color: var(--compliance-green); background: #F0FDFA; } 
        .kpi-teal { border-color: var(--intelligent-teal); background: #F0F9FF; }
        
        .kpi-label { 
            font-size: 1.1rem; font-weight: 800; color: var(--primary-navy); 
            display: block; margin-bottom: 8px; letter-spacing: -0.02em; line-height: 1.2;
        }
        
        .kpi-value { font-size: 2.8rem; font-weight: 800; color: var(--text-dark); margin: 5px 0; letter-spacing: -1px; }
        .kpi-sub { font-size: 0.95rem; font-weight: 500; color: var(--text-light); margin-top: 5px; }

        /* CADENCE BAR */
        .cadence-container { margin-top: 30px; background: #fff; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .cadence-bar-wrapper { display: flex; height: 40px; width: 100%; border-radius: 8px; overflow: hidden; margin-top: 15px; }
        .cadence-segment { display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.75rem; transition: width 0.5s ease; position: relative; border-right: 1px solid rgba(255,255,255,0.2); }
        .cadence-segment:last-child { border-right: none; }
        
        .seg-1 { background-color: var(--g1-attention); }
        .seg-2 { background-color: var(--g2-objectives); }
        .seg-3 { background-color: var(--g3-recall); }
        .seg-4 { background-color: var(--g4-content); }
        .seg-5 { background-color: var(--g5-guidance); }
        .seg-6 { background-color: var(--g6-practice); }
        .seg-7 { background-color: var(--g7-feedback); }
        .seg-8 { background-color: var(--g8-assess); }
        .seg-9 { background-color: var(--g9-retention); }
        
        .cadence-legend-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 25px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: var(--text-dark); }
        .dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .legend-meta { color: var(--text-light); font-size: 0.8rem; margin-left: auto; font-family: 'IBM Plex Mono', monospace; }

        .cadence-placeholder { background: #F8FAFC; border: 1px dashed #CBD5E1; padding: 40px; text-align: center; border-radius: 12px; margin-top: 30px; }
        .cadence-placeholder h3 { font-size: 1.2rem; margin: 0 0 10px 0; color: var(--text-dark); }
        .cadence-placeholder p { font-size: 0.9rem; color: var(--text-light); max-width: 600px; margin: 0 auto 15px auto; }
        .tag-pill { background: #E0F7FA; color: #006064; padding: 2px 8px; border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 0.8rem; border: 1px solid #B2EBF2; }

        /* DEBUG LOG TABLE */
        .debug-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 10px; }
        .debug-table th { background: #eee; text-align: left; padding: 5px; font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; color: #444; }
        .debug-table td { border-bottom: 1px solid #f0f0f0; padding: 6px; font-family: 'IBM Plex Mono', monospace; color: #555; vertical-align: middle; }
        .log-row-skipped { background: #fff5f5; color: #991b1b; }
        .log-row-funded { background: #f0fdf4; color: #166534; }
        .log-row-estimated { background: #fff; color: #64748b; }

        .gagne-bar-container { margin-top: 15px; background: rgba(0,0,0,0.06); height: 8px; border-radius: 4px; overflow: hidden; }
        .gagne-bar-fill { height: 100%; border-radius: 4px; }

        .slide-card { background: var(--white); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 30px; overflow: hidden; border: 1px solid #e2e8f0; position: relative; }
        .slide-header { background: #fff; padding: 20px 35px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .slide-title { font-weight: 800; font-size: 1.25rem; color: var(--primary-navy); }
        .slide-badge { background: var(--neutral-bg); color: var(--text-light); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .slide-card.exempt { opacity: 0.7; background: #fafafa; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 18px 35px; background: #f8fafc; color: var(--text-light); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 22px 35px; border-bottom: 1px solid #f1f5f9; font-size: 1rem; vertical-align: top; color: var(--text-dark); }
        tr:last-child td { border-bottom: none; }
        
        .badge { display: inline-block; padding: 5px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-fail { background-color: rgba(233, 180, 76, 0.15); color: #B07D18; border: 1px solid rgba(233, 180, 76, 0.2); }
        .badge-warn { background-color: #FFF8E1; color: #F57F17; border: 1px solid #FFE082; }
        .badge-info { background-color: #E0F7FA; color: #006064; border: 1px solid #B2EBF2; }
        .badge-manual { background-color: #F1F5F9; color: #64748B; border: 1px solid #E2E8F0; }
        
        .swatch-container { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .swatch { width: 32px; height: 32px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .arrow { color: var(--text-light); font-size: 1rem; }
        .fix-details { font-size: 0.85rem; color: #64748B; }
        
        h2.section-title { color: var(--primary-navy); font-size: 1.6rem; margin-top: 60px; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; font-weight: 800; }
        h2.section-title::before { content: ''; display: block; width: 6px; height: 28px; background: var(--intelligent-teal); border-radius: 3px; }

        /* --- MAGIC TOGGLE CLASS --- */
        #full-details { display: none; }
        body.print-mode #full-details { display: block !important; }

        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white; font-size: 12pt; }
            .header { box-shadow: none !important; padding: 2rem 0; color: #000; background: none; border-bottom: 2px solid #000; }
            .container { padding: 0; max-width: 100%; }
            .kpi-card, .slide-card, .cadence-container { box-shadow: none !important; border: 1px solid #ccc !important; break-inside: avoid; }
            .slide-card { page-break-inside: avoid; }
            [data-tippy-root] { display: none !important; }
            #full-details, #dashboard-content { display: block !important; }
            h1, h2, h3, .kpi-value, .kpi-label { font-family: sans-serif !important; font-weight: bold; }
        }
    </style>
</head>
<body>

<script>
    /* INSERT_JSON_HERE */
</script>

<div id="dashboard-content">
    <div style="padding:80px; text-align:center; color:#94a3b8; font-family:'Plus Jakarta Sans', sans-serif;">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; margin-bottom: 15px; color: var(--intelligent-teal);"></i><br>
        Generating Report...
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        if (typeof auditData === 'undefined') return;
        renderDashboard(auditData);
        
        tippy('[data-tooltip]', {
            content: (reference) => reference.getAttribute('data-tooltip'),
            theme: 'light-border',
            animation: 'scale',
            placement: 'top',
            arrow: true,
            allowHTML: true,
        });

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('print') === 'true') {
            document.body.classList.add('print-mode');
            setTimeout(() => { window.print(); }, 800);
        }
    });

    function renderDashboard(data) {
        const s = data.summary;
        const e = s.executive_metrics;
        const c = s.content_metrics;
        const p = s.pacing_metrics;

        // Existing KPI Data (Slides Count)
        const getPct = (str) => (!str || !str.includes('(')) ? 0 : parseFloat(str.split('(')[1].replace('%)',''));
        const pctPresent = getPct(e.slides_present_content);
        const pctElicit = getPct(e.slides_elicit_performance);
        const cntPresent = e.slides_present_content ? parseInt(e.slides_present_content.split(' ')[0]) : 0;
        const cntElicit = e.slides_elicit_performance ? parseInt(e.slides_elicit_performance.split(' ')[0]) : 0;
        const cntOther = parseInt(e.other_slides || 0);

        // --- TIME-BASED CADENCE LOGIC ---
        const gagneMinutes = {
            1: { name: "Gain Attention", mins: 0 },
            2: { name: "Inform Objectives", mins: 0 },
            3: { name: "Stimulate Recall", mins: 0 },
            4: { name: "Present Content", mins: 0 },
            5: { name: "Provide Guidance", mins: 0 },
            6: { name: "Elicit Performance", mins: 0 },
            7: { name: "Provide Feedback", mins: 0 },
            8: { name: "Assess Performance", mins: 0 },
            9: { name: "Enhance Retention", mins: 0 }
        };

        const allSlides = data.slide_content || {};
        const sortedSlideKeys = Object.keys(allSlides).sort((a,b) => parseInt(a) - parseInt(b));
        
        let totalTimeAccumulated = 0;
        let lastActivity = "";
        let slidesWithTags = 0;
        let debugRows = ""; // For the log table

        sortedSlideKeys.forEach(key => {
            const slide = allSlides[key];
            const notes = (slide.notes || "").toLowerCase();
            const fullText = (slide.full_text || slide.text || "").toLowerCase();
            const sNum = slide.slide_number || key;
            
            // 1. Determine Time
            let explicitTime = 0;
            const timeMatch = notes.match(/(?:time|duration):\s*(\d+)/i) || fullText.match(/(?:time|duration):\s*(\d+)/i);
            if (timeMatch) explicitTime = parseInt(timeMatch[1]);

            // Activity Grouping
            const actMatch = notes.match(/activity:\s*([^\n]+)/i) || fullText.match(/activity:\s*([^\n]+)/i);
            const currentActivity = actMatch ? actMatch[1].trim().toLowerCase() : "";

            let slideTimeContribution = 0;
            let logStatus = "";

            if (explicitTime > 0) {
                if (currentActivity && currentActivity === lastActivity) {
                    slideTimeContribution = 0; 
                    logStatus = "SKIPPED (Funded by prev)";
                } else {
                    slideTimeContribution = explicitTime;
                    if (currentActivity) lastActivity = currentActivity; 
                    logStatus = "FUNDED (Explicit Time)";
                }
            } else {
                const wordCount = (notes + " " + fullText).split(/\s+/).length;
                slideTimeContribution = Math.max(0.5, wordCount / 130);
                logStatus = "ESTIMATED (Word Count)";
            }

            // 2. Robust Gagné Regex Matching
            let eventId = 0;
            let eventNameDetected = "None";

            if (notes.match(/elicit\s*performance|practice/i)) { eventId = 6; }
            else if (notes.match(/present\s*content|presentation/i)) { eventId = 4; }
            else if (notes.match(/provide\s*feedback/i)) { eventId = 7; }
            else if (notes.match(/provide\s*guidance/i)) { eventId = 5; }
            else if (notes.match(/assess\s*performance|assessment/i)) { eventId = 8; }
            else if (notes.match(/gain\s*attention/i)) { eventId = 1; }
            else if (notes.match(/inform\s*objectives/i)) { eventId = 2; }
            else if (notes.match(/stimulate\s*recall/i)) { eventId = 3; }
            else if (notes.match(/(?:enhance|improve)\s*(?:transfer\s*(?:&|and)\s*)?retention/i) || notes.match(/retention\s*(?:&|and)\s*transfer/i)) { eventId = 9; }

            // 3. Attribute Time
            if (eventId > 0) {
                gagneMinutes[eventId].mins += slideTimeContribution;
                totalTimeAccumulated += slideTimeContribution;
                slidesWithTags++;
                eventNameDetected = gagneMinutes[eventId].name;
            } else {
                // If it was Explicitly Funded but had no Tag, we still count time but it goes to "Untagged" bucket effectively
                // This logic ensures totalTimeAccumulated matches the bar
                if (slideTimeContribution > 0 && logStatus.includes("FUNDED")) {
                     // Optionally assign to "Present Content" default or keep separate
                }
            }

            // Build Debug Row
            const rowClass = logStatus.includes("SKIPPED") ? 'log-row-skipped' : (logStatus.includes("FUNDED") ? 'log-row-funded' : 'log-row-estimated');
            
            debugRows += `<tr class="${rowClass}">
                <td>${sNum}</td>
                <td>${eventId > 0 ? eventNameDetected : '-'}</td>
                <td>${Math.round(slideTimeContribution * 10) / 10} min</td>
                <td>${logStatus}</td>
                <td style="font-size:0.65rem;">${notes.substring(0, 50)}...</td>
            </tr>`;
        });

        const totalSlides = s.total_slides_checked;
        const tagRatio = totalSlides > 0 ? (slidesWithTags / totalSlides) : 0;
        const cadenceThreshold = 0.8; 
        const showCadence = tagRatio >= cadenceThreshold;

        let cadenceHtml = '';
        
        if (showCadence) {
            let barHtml = '';
            let legendHtml = '';
            
            Object.keys(gagneMinutes).forEach(key => {
                const g = gagneMinutes[key];
                const pct = (totalTimeAccumulated > 0) ? Math.round((g.mins / totalTimeAccumulated) * 100) : 0;
                
                if (pct > 0) {
                    barHtml += `<div class="cadence-segment seg-${key}" style="width: ${pct}%" data-tooltip="${g.name}: ${Math.round(g.mins)} min (${pct}%)">${pct > 4 ? pct + '%' : ''}</div>`;
                }
                
                legendHtml += `
                <div class="legend-item">
                    <div class="dot seg-${key}"></div> ${g.name}
                    <span class="legend-meta">${Math.round(g.mins)} min (${pct}%)</span>
                </div>`;
            });

            cadenceHtml = `
            <div class="cadence-container">
                <div class="section-label" style="border:none; margin-bottom:10px;">Instructional Cadence Breakdown (Time Based)</div>
                <div style="font-size:0.95rem; color:var(--text-light); margin-bottom:20px;">
                    Time distribution based on activity headers and pacing analysis. (Total Planned Time: ${Math.round(totalTimeAccumulated)} min).
                </div>
                
                <div class="cadence-bar-wrapper">
                    ${barHtml}
                </div>
                
                <div class="cadence-legend-grid">
                    ${legendHtml}
                </div>

                <details style="margin-top:20px; font-size:0.8rem; color:#666;">
                    <summary style="cursor:pointer; font-weight:600; font-family:'Plus Jakarta Sans', sans-serif;">View Calculation Log (Debug)</summary>
                    <div style="max-height:300px; overflow-y:auto; border:1px solid #eee; margin-top:10px;">
                        <table class="debug-table">
                            <thead><tr><th>Slide</th><th>Event</th><th>Time</th><th>Logic</th><th>Snippet</th></tr></thead>
                            <tbody>${debugRows}</tbody>
                        </table>
                    </div>
                </details>
            </div>`;
        } else {
            cadenceHtml = `
            <div class="cadence-placeholder">
                <h3>Instructional Cadence Report Unavailable</h3>
                <p>We could not generate a meaningful time-based cadence timeline because fewer than 80% of your slides contain Gagné event tags.</p>
                <div style="font-size:0.8rem; opacity:0.7; margin-top:15px;">Current Tagged Ratio: ${Math.round(tagRatio * 100)}% (Requires 80%)</div>
                
                <details style="margin-top:20px; text-align:left; font-size:0.8rem; color:#666;">
                    <summary style="cursor:pointer; font-weight:600; font-family:'Plus Jakarta Sans', sans-serif;">View Debug Log</summary>
                    <div style="max-height:300px; overflow-y:auto; border:1px solid #eee; margin-top:10px;">
                        <table class="debug-table">
                            <thead><tr><th>Slide</th><th>Event</th><th>Time</th><th>Logic</th></tr></thead>
                            <tbody>${debugRows}</tbody>
                        </table>
                    </div>
                </details>
            </div>`;
        }

        const planned = p.total_planned_mins || 0;
        const projected = p.total_projected_mins || 0;
        const diff = Math.abs(projected - planned);
        const isGood = diff <= (planned * 0.1); 
        const pacingClass = isGood ? 'kpi-pass' : 'kpi-warn';
        const pacingStatus = isGood 
            ? `<span style="color:var(--compliance-green); font-weight:700;">✓ On Track</span> (within 10%)`
            : `<span style="color:var(--action-amber); font-weight:700;">⚠ Variance: ${Math.round(diff)} min</span>`;

        let maxSec = { name: "None", projected: 0, slide_count: 0 };
        if (p.sections && p.sections.length > 0) {
            maxSec = p.sections.reduce((prev, curr) => (prev.projected > curr.projected) ? prev : curr);
        }

        let issuesHtml = '';
        const slides = {};
        data.detailed_issues.forEach(i => {
            if (!slides[i.slide]) slides[i.slide] = [];
            slides[i.slide].push(i);
        });

        Object.keys(slides).sort((a,b)=>a-b).forEach(slideNum => {
            const items = slides[slideNum];
            const isExempt = items.some(i => i.result === "EXEMPT");
            
            issuesHtml += `<div class="slide-card ${isExempt ? 'exempt' : ''}">
                <div class="slide-header">
                    <div class="slide-title">Slide ${slideNum}</div>
                    <span class="slide-badge">${isExempt ? 'Skipped' : items.length}</span>
                </div>`;
            
            if (isExempt) {
                issuesHtml += `<div class="exempt-message">• EXEMPT FROM ANALYSIS •<br><span style="font-size:0.8rem; font-weight:400; opacity:0.7;">This slide was excluded by configuration.</span></div>`;
            } else {
                issuesHtml += `<table><thead><tr><th width="15%">Category</th><th width="15%">Shape</th><th width="40%">Details & Context</th><th width="30%">Recommended Action</th></tr></thead><tbody>`;
                items.forEach(issue => {
                    let bClass = 'badge-info';
                    if(issue.result==='FAIL') bClass='badge-fail';
                    if(issue.result==='WARNING' || issue.result==='AI WARNING') bClass='badge-warn';
                    if(issue.result==='MANUAL REVIEW') bClass='badge-manual';

                    let swatchHtml = '';
                    if (issue.suggested_fix_color && issue.original_bg_rgb && issue.original_text_rgb) {
                        swatchHtml = `<div class="swatch-container">
                            <div class="swatch" style="background-color: rgb(${issue.original_bg_rgb.join(',')});" title="Background"></div>
                            <div class="swatch" style="background-color: rgb(${issue.original_text_rgb.join(',')});" title="Current Text"></div>
                            <div class="arrow">➜</div>
                            <div class="swatch" style="background-color: rgb(${issue.suggested_fix_color.join(',')});" title="Suggested Text"></div>
                        </div>`;
                    }

                    issuesHtml += `<tr>
                        <td><span class="badge ${bClass}">${issue.result}</span><div style="font-size:0.75rem; margin-top:6px; color:var(--text-light); font-weight:600; font-family:'IBM Plex Mono', monospace;">${issue.check}</div></td>
                        <td><strong style="font-family:'Inter', sans-serif;">${issue.shape_name || 'Shape'}</strong></td>
                        <td>${issue.details}</td>
                        <td>${swatchHtml}<div class="fix-details">${issue.suggestion || 'Review manually.'}</div></td>
                    </tr>`;
                });
                issuesHtml += `</tbody></table>`;
            }
            issuesHtml += `</div>`;
        });

        const template = `
        <div class="header">
            <div>
                <h1>AuditSlide AI</h1>
                <div style="font-size: 1rem; opacity: 0.9; font-weight: 300; font-family:'Inter', sans-serif;">Automated Quality Assurance Report</div>
            </div>
            <div class="meta">
                <div style="margin-bottom:4px;"><strong>File:</strong> ${s.presentation_name}</div>
                <div><strong>Date:</strong> ${s.date_generated.split('T')[0]}</div>
            </div>
        </div>
        <div class="container">
            
            <div class="dashboard-section">
                <div class="section-label">Technical Health & Compliance</div>
                <div class="kpi-grid">
                    <div class="kpi-card kpi-total"><div class="kpi-label" data-tooltip="Total slides scanned.">Total Slides</div><div class="kpi-value">${s.total_slides_checked}</div><div class="kpi-sub">Analyzed</div></div>
                    <div class="kpi-card kpi-warn"><div class="kpi-label" data-tooltip="Total individual issues.">Total Findings</div><div class="kpi-value">${s.total_errors}</div><div class="kpi-sub" style="color:var(--action-amber)">Require Attention</div></div>
                    <div class="kpi-card kpi-pass"><div class="kpi-label" data-tooltip="Slides with 0 errors.">WCAG Compliance</div><div class="kpi-value">${e.wcag_compliance_rate}%</div><div class="kpi-sub" style="color:var(--compliance-green)">Pass Rate</div></div>
                    <div class="kpi-card"><div class="kpi-label" data-tooltip="Items for human check.">Manual Reviews</div><div class="kpi-value">${s.manual_reviews}</div><div class="kpi-sub">Items for Human Check</div></div>
                </div>
            </div>
            
            <div class="dashboard-section">
                <div class="section-label">Instructional Integrity (Gagné's 9 Events)</div>
                <div class="kpi-grid">
                    <div class="kpi-card kpi-total">
                        <div class="kpi-label" data-tooltip="Slides tagged as 'Present Content'.">Content Delivery</div>
                        <div class="kpi-value">${cntPresent} <span style="font-size:1.2rem; color:var(--text-light); font-weight:400;">(${pctPresent}%)</span></div>
                        <div class="kpi-sub">Slides "Present Content"</div>
                        <div class="gagne-bar-container"><div class="gagne-bar-fill fill-passive" style="width: ${pctPresent}%"></div></div>
                    </div>
                    <div class="kpi-card kpi-teal">
                        <div class="kpi-label" data-tooltip="Slides tagged as 'Elicit Performance'.">Learner Engagement</div>
                        <div class="kpi-value">${cntElicit} <span style="font-size:1.2rem; color:var(--text-light); font-weight:400;">(${pctElicit}%)</span></div>
                        <div class="kpi-sub" style="color:var(--intelligent-teal)">Slides "Elicit Performance"</div>
                        <div class="gagne-bar-container"><div class="gagne-bar-fill fill-active" style="width: ${pctElicit}%"></div></div>
                    </div>
                    <div class="kpi-card"><div class="kpi-label" data-tooltip="Intros, Objectives, Reviews.">Support Slides</div><div class="kpi-value">${cntOther}</div><div class="kpi-sub">Intro, Objectives, Reviews</div></div>
                </div>
                ${cadenceHtml}
            </div>

            <div class="dashboard-section">
                <div class="section-label">Content Quality & Voice</div>
                <div class="kpi-grid">
                    <div class="kpi-card kpi-warn"><div class="kpi-label" data-tooltip="Exceeding Reading Level.">Reading Complexity</div><div class="kpi-value">${c.reading_complexity_fails}</div><div class="kpi-sub" style="color:var(--action-amber)">Slides > Grade Target</div></div>
                    <div class="kpi-card kpi-teal"><div class="kpi-label" data-tooltip="Passive vs Active Voice.">Voice & Tone</div><div class="kpi-value">${c.passive_voice_count}</div><div class="kpi-sub" style="color:var(--intelligent-teal)">Passive Voice Alerts</div></div>
                    <div class="kpi-card"><div class="kpi-label" data-tooltip="Blacklisted words.">Brand Jargon</div><div class="kpi-value">${c.jargon_count}</div><div class="kpi-sub">Blacklisted Words</div></div>
                </div>
            </div>

            <div class="dashboard-section">
                <div class="section-label">Pacing & Seat Time</div>
                <div class="kpi-grid">
                    <div class="kpi-card ${pacingClass}">
                        <div class="kpi-label" data-tooltip="Estimated based on word count & timing.">Projected Duration</div>
                        <div class="kpi-value">${Math.round(projected)} min</div>
                        <div class="kpi-sub">${pacingStatus}</div>
                    </div>
                    <div class="kpi-card kpi-teal">
                        <div class="kpi-label" data-tooltip="Sum of 'Time:' headers.">Explicitly Planned</div>
                        <div class="kpi-value">${Math.round(planned)} min</div>
                        <div class="kpi-sub" style="color:var(--intelligent-teal)">Sum of 'Time:' Headers</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label" data-tooltip="Heaviest Section.">Heaviest Section</div>
                        <div class="kpi-value" style="font-size:1.5rem; margin-top:15px;">${maxSec.name.substring(0,20)}...</div>
                        <div class="kpi-sub">${Math.round(maxSec.projected)} mins (${maxSec.slide_count} slides)</div>
                    </div>
                </div>
            </div>

            <div id="full-details">
                <h2 class="section-title">Detailed Findings</h2>
                ${issuesHtml}
            </div>
        </div>`;

        document.getElementById('dashboard-content').innerHTML = template;
    }
</script>
</body>
</html>
